using System;
using System.Collections.Generic;
using System.Linq;
using Engine.Components;
using Engine.Entities;
using PlayGen.ITAlert.Simulation.Components.Items;
using PlayGen.ITAlert.Simulation.Configuration;
using PlayGen.ITAlert.Simulation.Modules.Antivirus.Components;
using PlayGen.ITAlert.Simulation.Modules.Malware.Components;

namespace PlayGen.ITAlert.Simulation.Scenario.Evaluators.Filters
{
	public class MalwareGenomeFilter : IEntityFilter<Simulation, SimulationConfiguration>
	{
		private readonly int _genome;

		private ComponentMatcherGroup<MalwareGenome> _malwareMatcherGroup;

		public MalwareGenomeFilter(int genome)
		{
			_genome = genome;
		}

		public void Initialize(Simulation ecs, SimulationConfiguration configuration)
		{
			_malwareMatcherGroup = ecs.MatcherProvider.CreateMatcherGroup<MalwareGenome>();
		}

		public bool Evaluate(Entity entity)
		{
			return _malwareMatcherGroup.TryGetMatchingEntity(entity.Id, out var malwareTuple)
				&& (malwareTuple.Component1.Value & _genome) == _genome;
		}

		public void Dispose()
		{
			_malwareMatcherGroup?.Dispose();
		}
	}
}
