using System;
using System.Collections.Generic;
using System.Linq;
using Engine.Commands;
using Engine.Components;
using Engine.Entities;
using PlayGen.ITAlert.Simulation.Common;
using PlayGen.ITAlert.Simulation.Components.Common;
using PlayGen.ITAlert.Simulation.Components.Movement;
using PlayGen.ITAlert.Simulation.Configuration;
using PlayGen.ITAlert.Simulation.Systems.Movement;

namespace PlayGen.ITAlert.Simulation.Commands
{
	public class CreateMalwareCommand : ICommand
	{
		public string Archetype { get; set; }

		public int NodeId { get; set; }

		//public IdentifierType IdentifierType { get; set; }

		public int? Genome { get; set; }

		public int? VisibleTo { get; set; }
	}

	public class CreateMalwareCommandHandler : CommandHandler<CreateMalwareCommand>
	{
		private readonly IEntityFactoryProvider _entityFactoryProvider;
		private readonly MovementSystem _movementSystem;

		private readonly ComponentMatcherGroup<GraphNode, Visitors> _nodeMatcherGroup;

		public CreateMalwareCommandHandler(IEntityFactoryProvider entityFactoryProvider, 
			IMatcherProvider matcherProvider,
			MovementSystem movementSystem)
		{
			_entityFactoryProvider = entityFactoryProvider;
			_movementSystem = movementSystem;
			_nodeMatcherGroup = matcherProvider.CreateMatcherGroup<GraphNode, Visitors>();
		}

		protected override bool TryProcessCommand(CreateMalwareCommand command)
		{
			if (string.IsNullOrEmpty(command.Archetype) == false
				&& _nodeMatcherGroup.TryGetMatchingEntity(command.NodeId, out var nodeTuple))
			{
				if (_entityFactoryProvider.TryCreateEntityFromArchetype(command.Archetype, out var malware))
				{
					_movementSystem.AddVisitor(nodeTuple.Entity, malware);
					return true;
				}
				malware?.Dispose();
			}
			return false;

		}
	}
}
